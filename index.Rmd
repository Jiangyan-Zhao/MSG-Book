--- 
title: "现代统计图形"
subtitle: "Modern Statistical Graphics"
author: 
  - 谢益辉
  - 黄湘云
  - 赵鹏
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: ctexbook
output:
  bookdown::pdf_book:
    keep_tex: yes
    dev: "cairo_pdf"
    latex_engine: xelatex
    citation_package: natbib
    template: tex/template.tex
    pandoc_args:  --top-level-division=chapter
    toc_depth: 3
    toc_unnumbered: no
    toc_appendix: yes
    quote_footer: ["\\begin{flushright}", "\\end{flushright}"]
bibliography:
  - bib/book.bib
  - bib/MSG-packages.bib
  - bib/Modern-Stat-Graphics.bib
biblio-style: plainnat
natbiboptions: "authoryear,square"
link-citations: yes
graphics: yes
mathspec: yes
lot: yes
lof: yes
classoption: "UTF8,twoside"
papersize: b5
colorlinks: yes
geometry:
  - tmargin=2.5cm
  - bmargin=2.5cm
  - lmargin=3.5cm
  - rmargin=2.5cm
description: "现代统计图形书稿"
subject: "统计图形, 数据可视化"
keywords: 
- R 语言
- 统计图形
- 统计学
- 图形元素
- 图形系统
- 统计图形软件
- 数据可视化
github-repo: XiangyunHuang/MSG-Book
url: 'https\://bookdown.org/xiangyun/msg/'
---

```{r, include=FALSE}
Sys.setlocale("LC_CTYPE", "Chinese")

options(width = 55)
options(bookdown.render.file_scope = FALSE)

# 安装本书需要的 R 包，按字母排序
lapply(c(
  "alphahull", "animation", "aplpack", "bookdown",
  "corrplot", "cowplot", "formatR", "fun",
  "GGally", "gganimate", "ggplot2", "igraph",
  "magick", "maps", "maptools", "MSG", "mvtnorm",
  "pdftools", "plot3D", "plotrix",
  "randomForest", "rgeos", "rggobi", "rgl",
  "scatterplot3d", "showtext", "sna", "sp", "survminer", "svglite",
  "TeachingDemos", "tikzDevice", "vcd", "vioplot"
), function(pkg) {
  if (system.file(package = pkg) == "") install.packages(pkg)
})

# automatically create a bib database for R packages
bib <- knitr::write_bib(
  x = c(
    .packages(),
    "alphahull", "aplpack", "corrplot",
    "formatR", "fun", "KernSmooth",
    "GGally", "ggpointdensity",
    "hexbin", "htmlwidgets", "heatmaply",
    "iplots", "leaflet",
    "MSG", "maps", "Matrix",
    "quantreg",
    "rggobi", "rgl", "rpart", "RColorBrewer",
    "sm", "survival",
    "TeachingDemos", "tikzDevice", "tuneR",
    "vcd", "vioplot"
  ), file = NULL, prefix = ""
)
bib <- unlist(bib)
# remove the ugly single quotes required by CRAN policy
bib <- gsub("(\\\n)", " ", bib)
bib <- gsub("'(Htmlwidgets|iframes|TeX Live|LaTeX|ggplot2|plotly|Leaflet|GGobi)'", "\\1", bib)
xfun::write_utf8(bib, "bib/MSG-packages.bib")



# convert pdf to png
to_png <- function(fig_path) {
  png_path <- sub("\\.pdf$", ".png", fig_path)
  magick::image_write(magick::image_read_pdf(fig_path), format = "png", path = png_path, 
                      density = 300, quality = 100)
  return(png_path)
}

library(formatR)

is_latex <- identical(knitr::opts_knit$get("rmarkdown.pandoc.to"), "latex")
is_html <- identical(knitr::opts_knit$get("rmarkdown.pandoc.to"), "html")

knitr::knit_hooks$set(
  optipng = knitr::hook_optipng,
  pdfcrop = knitr::hook_pdfcrop,
  small.mar = function(before, options, envir) {
    if (before) par(mar = c(4, 4, .1, .1), cex.lab = .95, cex.axis = .9, mgp = c(2, .7, 0), tcl = -.3) # smaller margin on top and right
  },
  font.cn = function(before, options, envir) {
    if (before) pdf.options(family = "GB1")
  },
  font.en = function(before, options, envir) {
    if (before) pdf.options(family = "Times")
  }
)

knitr::opts_chunk$set(
  fig.align = "center",
  cache = TRUE,
  small.mar = TRUE,
  fig.showtext = TRUE,
  dpi = 300
)

if (is_latex) {
  knitr::opts_chunk$set(
    out.width = "70%"
  )
}

```
